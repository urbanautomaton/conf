# shellcheck shell=bash
# vi: set ft=sh:

function chruby_default() {
  if [[ -n "$CHRUBY_DEFAULT" ]]; then
    chruby "$CHRUBY_DEFAULT"
  else
    chruby_reset
  fi
}

function use_gemset() {
  local -r current_dir=$1

  local gem_dir=${current_dir//\//\%}
  gem_dir=${gem_dir// /_}
  gem_dir="${HOME}/.gem/gemsets/${gem_dir}"
  RUBY_AUTO_GEMSET="${gem_dir}"
  gem_home "${RUBY_AUTO_GEMSET}"
}

function enter_ruby_version {
  local -r current_dir=$1
  local version
  read -r version <"${current_dir}/.ruby-version"

  if [[ -n "${version}" ]]; then
    chruby "${version}"
    use_gemset "${current_dir}"

    RUBY_AUTO_BINSTUBS="${current_dir}/bin:${current_dir}/.bin"
    prepend_path "${RUBY_AUTO_BINSTUBS}"
  fi
}

function exit_ruby_version {
  [[ -n "${RUBY_AUTO_BINSTUBS}" ]] && remove_from_path "$RUBY_AUTO_BINSTUBS"
  [[ -n "${RUBY_AUTO_GEMSET}" ]] && gem_home -
  chruby_default

  unset RUBY_AUTO_BINSTUBS
  unset RUBY_AUTO_GEMSET
}

if command_exists "chruby" && command_exists "gem_home"; then
  register_env_hook .ruby-version ruby_version
fi
